#!/usr/bin/env ruby

project_root = ENV['GAME_ROOT']
avian_root = ENV['AVIAN_ROOT']
build_dir = File.join("/", "tmp", "avian", "build")
platform_support = File.join(project_root, "platform_support", "mruby")

shared_boot =
  File.join(avian_root, "lib", "avian", "platforms", "shared-mruby", "shared_boot.rb")

load(shared_boot)

unless File.directory?(File.join(build_dir, "sdl-desktop"))
  puts "\n--- Cloning SDL ---"
  system("git clone https://github.com/spurious/SDL-mirror.git sdl-desktop") ||
    raise("Failed to clone SDL")

  puts "\n--- Compiling SDL ---"
  FileUtils.cd(File.join(build_dir, "sdl-desktop"))
  system("./configure && make") || begin
    FileUtils.remove_dir(File.join(build_dir, "sdl-desktop"))
    raise("Failed to compile SDL")
  end
end

puts "\n--- Preparing c files ---"
File.open(File.join(build_dir, "output.c"), 'w') do |write_file|
  ["app.c", File.join(__dir__, "main.c")].each do |filepath|
    write_file.puts File.readlines(filepath).join
  end
end

mruby_path = `bundle exec mundle path`.chomp

puts "\n--- Compiling c files ---"
clang = %W(
  clang
    output.c
    -ooutput
    -I#{mruby_path}/include
    -lmruby
    -L#{mruby_path}/build/host/lib/
    -I./sdl-desktop/include
    -lSDL2
)

system(*clang) || raise("Compiling failed")
puts "Compiling complete."

system(*%W(chmod +x ./output))
system("./output")
