#!/usr/bin/env ruby

project_root = ENV['GAME_ROOT']
avian_root = ENV['AVIAN_ROOT']

build = ""
fastlane = ""
case ENV['AVIAN_BUILD']
when "run_simulator"
  build = ""
when "run_device"
  build = "device"
  fastlane = "development"
when "build_device"
  build = "clean archive:distribution"
  fastlane = "appstore"
else
  raise "Invalid AVIAN_BUILD"
end

require 'process_output_wrapper'
include ProcessOutputWrapper::DSL

Bundler.with_clean_env do
  build_dir = File.join(project_root, "tmp", "build")
  platform_support = File.join(project_root, "platform_support", "ios")

  gemfile = File.join(platform_support, "Gemfile")
  system("BUNDLE_GEMFILE=#{gemfile} bundle check >/dev/null 2>/dev/null") ||
    system("bundle install --gemfile=#{gemfile}") || begin
      STDERR.puts "Bundling #{gemfile} failed"
      exit 1
  end

  FileUtils.mkdir_p(build_dir)
  FileUtils.mkdir_p(File.join(build_dir, "app", "_avian"))
  FileUtils.mkdir_p(File.join(build_dir, "app", "_game"))

  # Copy files from the actual game project into tmp/build/app/_game
  ["app", "config", "lib"].each do |game_files|
    FileUtils.cp_r(project_root + "/" + game_files + "/.", "#{build_dir}/app/_game/#{game_files}/")
  end

  # FileUtils.cd(build_dir) # TODO: cd to fastlane
  # if fastlane != ""
  #   system("bundle exec fastlane match #{fastlane}")
  # end

  # Copy the resources from the game project into tmp/build/resources/
  FileUtils.cp_r(project_root + "/resources" + "/.", "#{build_dir}/resources/")
  # Copy the platform specific resources into tmp/build/resources/
  FileUtils.cp_r(platform_support.to_s + "/resources" + "/.", "#{build_dir}/resources/")

  # Copy support files to tmp/build/
  FileUtils.cp_r(File.join(platform_support, "Gemfile"), build_dir)
  FileUtils.cp_r(File.join(platform_support, "Gemfile.lock"), build_dir)
  FileUtils.cp_r(File.join(platform_support, "Rakefile"), build_dir)

  # Copy ios specific avian files to tmp/build/app/_avian/ios
  avian_files = File.join(avian_root, "lib", "avian", "platforms", "ios-rubymotion", "ios")
  FileUtils.cp_r(avian_files.to_s + "/.", "#{build_dir}/app/_avian/ios/")

  # Copy avian engine files to tmp/build/app/_avian/engine
  engine_files = File.join(avian_root, "lib", "avian", "engine")
  FileUtils.cp_r(engine_files.to_s + "/.", "#{build_dir}/app/_avian/engine/")

  # Set the current working directory to the build
  FileUtils.cd(build_dir)

  if system("bundle show motion-cocoapods >/dev/null 2>&1")
    result = run_this "BUNDLE_GEMFILE=#{gemfile} bundle exec rake pod:install" do
      to_hide = [
        '[!] If you need to update CocoaPods repository to install newer libraries, please run "pod repo update" command before.',
        'Analyzing dependencies',
        'Downloading dependencies',
        'Generating Pods project',
        'Skipping User Project Integration',
        'Pod installation complete!'
      ]
      whenever { to_hide.all? { |start| !line.start_with?(start) } }
        .do { puts line }
    end

    exit(result) if result != 0
  end

  printed_warnings = []
  success = false
  run_this "BUNDLE_GEMFILE=#{gemfile} bundle exec rake #{build} device_name=\"iPhone 11 Pro\"" do
    whenever { line.start_with?("   Compile") }
      .do { print("\e[32m.\e[0m") }

    whenever { line.start_with?("      Link") }
      .do { print("\e[32m.\e[0m") }

    whenever { line.start_with?("      Copy") }
      .do { print("\e[32m.\e[0m") }

    whenever { line.start_with?("  WARNING!") }
      .do {
        unless printed_warnings.include?(line)
          printed_warnings << line
          puts("\n\r\e[33m#{line.strip}\e[0m")
        end
      }

    whenever { line.start_with?("  Simulate") }
      .do {
        puts "\n\rSuccess"
        success = true
      }

    whenever { line.start_with?(")") && success }
      .do {
        print_normally!
      }

    whenever { line.start_with?("    ERROR!") }
      .do {
        puts line
        print_normally!
      }

    whenever { line.start_with?("Remote process has quit.") }
      .do { print_wrapped! }

    whenever { line.start_with?("*** First throw call stack:") }
      .do { print_wrapped! }

    whenever { line.start_with?("rake aborted!") || line.start_with?("(main)> rake aborted!") }
      .do { print_wrapped! }

    whenever { line.include?("Terminating app due to uncaught exception") }
      .do { print_wrapped! }
  end
end
